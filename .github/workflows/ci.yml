name: Full CI Build & Notify

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # -----------------------------
  build:
    name: ðŸš€ Build App
    runs-on: windows-latest

    permissions:
      contents: read
      pull-requests: write
      security-events: write

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Build Console vÃ o thÆ° má»¥c BuildOutput
        run: dotnet publish ./Server/Server.csproj -c Release -o ./BuildOutput --self-contained false -r win-x64

      - name: Copy FE vÃ o BuildOutput
        shell: pwsh
        run: |
          $feSource = "${{ github.workspace }}/fe"
          $beDestination = "${{ github.workspace }}/BuildOutput/fe"
          if (Test-Path $beDestination) { Remove-Item $beDestination -Recurse -Force }
          Copy-Item $feSource $beDestination -Recurse
          Write-Host "ÄÃ£ copy FE vÃ o BuildOutput cá»§a BE."

      - name: Copy DB vÃ o BuildOutput
        shell: pwsh
        run: |
          $dbSource = "${{ github.workspace }}/db"
          $beDestination = "${{ github.workspace }}/BuildOutput/db"
          if (Test-Path $beDestination) { Remove-Item $beDestination -Recurse -Force }
          Copy-Item $dbSource $beDestination -Recurse
          Write-Host "ÄÃ£ copy DB vÃ o BuildOutput cá»§a BE."

      - name: Upload thÆ° má»¥c BuildOutput (GitHub tá»± zip khi táº£i vá»)
        uses: actions/upload-artifact@v4
        with:
          name: KontrollerApp
          path: BuildOutput
          if-no-files-found: error
          retention-days: 7

  # -----------------------------
  report:
    runs-on: ubuntu-latest
    # needs: [build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Láº¥y toÃ n bá»™ history cho git blame

      - name: CÃ i jq (náº¿u chÆ°a cÃ³)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: TÃ­nh sá»‘ Ä‘iá»ƒm Ä‘Ã³ng gÃ³p báº±ng git
        run: |
          echo "ðŸ“Š **BÃO CÃO CI â€“ $(TZ='Asia/Ho_Chi_Minh' date '+%Y-%m-%d %H:%M:%S')**" >> report.txt

          echo "" >> report.txt
          echo "ðŸ§¾ **ThÃ´ng tin commit má»›i nháº¥t:**" >> report.txt
          echo "- Commit bá»Ÿi: $(git log -1 --pretty=format:'%an')" >> report.txt
          echo "- Message: \"$(git log -1 --pretty=format:'%s')\"" >> report.txt
          echo "- File thay Ä‘á»•i trong commit má»›i nháº¥t:" >> report.txt
          git diff-tree --no-commit-id --name-only -r HEAD | sed 's/^/  - /' >> report.txt
          
          echo "" >> report.txt
          echo "ðŸ§¾ **BÃ¡o cÃ¡o sá»‘ commit Ä‘Ã³ng gÃ³p**:" >> report.txt

          # Äáº¿m commit tá»«ng tÃ¡c giáº£
          git shortlog -s -n --all > commit.txt
          while read count author_raw; do
            author=$(echo "$author_raw" | sed 's/^ *//; s/["'\'']//g')
            echo "- author $author: $count commit" >> report.txt
          done < commit.txt

          # Tá»•ng sá»‘ commit toÃ n repo
          total_commits=$(git rev-list --count HEAD)
          echo "- Tá»•ng sá»‘ commit toÃ n repo: \`$total_commits\`" >> report.txt
          
          echo "" >> report.txt
          echo "ðŸ§¾ **BÃ¡o cÃ¡o sá»‘ dÃ²ng Ä‘Ã³ng gÃ³p**:" >> report.txt

          # XÃ³a file táº¡m náº¿u cÃ³
          rm -f authors.txt authors_count.txt

          # Láº¥y táº¥t cáº£ file do git quáº£n lÃ½ (khÃ´ng giá»›i háº¡n Ä‘uÃ´i)
          git ls-files | while read file; do
            git blame --line-porcelain "$file" | grep "^author " >> authors.txt || true
          done

          # Äáº¿m vÃ  lá»c tÃ¡c giáº£
          sort authors.txt | uniq -c | sort -nr > authors_count.txt

          # Format káº¿t quáº£
          while read count author_raw; do
            author=$(echo "$author_raw" | sed 's/^ *//; s/["'\'']//g')
            echo "- $author: \`$count dÃ²ng\`" >> report.txt
          done < authors_count.txt

          # âœ… TÃ­nh tá»•ng sá»‘ dÃ²ng
          total_lines=$(awk '{sum += $1} END {print sum}' authors_count.txt)
          echo "- Tá»•ng sá»‘ dÃ²ng Ä‘Æ°á»£c thá»‘ng kÃª: \`$total_lines\`" >> report.txt
          echo "- Tá»•ng sá»‘ file Ä‘Æ°á»£c thá»‘ng kÃª: \`$(git ls-files | wc -l)\`" >> report.txt

          echo "" >> report.txt
          cat report.txt

      - name: Gá»­i bÃ¡o cÃ¡o Ä‘áº¿n Discord
        run: |
          message=$(cat report.txt)
          payload=$(jq -Rn --arg msg "$message" '{content: $msg}')

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$payload" \
               "$DISCORD_WEBHOOK"
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
